{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="main">

        <!--hero section start-->
        <section class="hero-equal-height pt-165 pb-100 " style="background-color: #6665e5; ">
            <div class="container">
                <div class="row align-items-top justify-content-between">
                    <div class="col-lg-4 col-12">
                        <div class="hero-content-wrap text-white">
                            <h1 class="text-white">The Violence Dataset</h1>
                            <p class="lead">The Collective Violence Early Warning (CVEW) Dataset is a comprehensive monitoring tool and early warning system for collective violence and conflict in Indonesia.</p>

                        </div>
                    </div>
                    <div class="col-lg-1">

                    </div>
                    <div class="col-lg-7">
                        <div class="row align-items-top justify-content-between">
                            <div class="col-md-6 col-lg-6">
                                <div class="single-promo-2  text-white pt-3 h-100">
                                    <h4 class="text-white">111</h4>
                                    <h5 class="text-white">Violent outbreaks</h5>
                                    <small>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ultricies quam ac elit tempor, ac dapibus est maximus. </small>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-6">
                                <div class="single-promo-2 text-white pt-3 h-100">
                                    <h4 class="text-white">100</h4>
                                    <h5 class="text-white">Fatal encounters</h5>
                                    <small>Sed mattis dolor augue, vel lobortis lacus faucibus id. </small>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-6">
                                <div class="single-promo-2 text-white pt-3 h-100">
                                    <h4 class="text-white">31 %</h4>
                                    <h5 class="text-white">Female casualties</h5>
                                    <small>Lorem ipsum dolor sit amet, consectetur adipiscing elit. <br> Nulla ultricies quam ac elit tempor.</small>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-6">
                                <div class="single-promo-2 text-white pt-3 h-100">
                                    <h4 class="text-white">15 Million</h4>
                                    <h5 class="text-white">Child victims</h5>
                                    <small>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>
        <!--hero section end-->

        <!--domain search cta type section start-->
        <section class="ptb-100"">
             <div class="container ">
                <h2>Dashboard</h2>
             </div>
            <hr class="pb-100" style="border-top: 1px solid black;">
            <div class="container">
                <div class="row">
                    <div class="col-md-3">
                        <div class="section-heading">
                            <h4>lorem ipsum</h4>
                            <p>
                                Discover our latest publications, offering insights into key topics such as renewable energy, emission reduction strategies, and sustainable development.
                            </p>
                        </div>

                        <div class="row pt-20">
                            <div class="col-md-12">
                                <label for="yearFilter">Select Year:</label><br>
                                <select id="yearFilter" class="btn outline-btn" style="width:100%;"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1"></div>
                    <div class="col-md-8 ">
                        <div id="container" class=" ptb-10 bg-gray"></div>

                    </div>
                </div>
            </div>
        </section>
        <!--domain search cta type section end-->
        <section class="our-blog-section bg-gray">

            <div class="container">
                <div class="row">
                    <div class="col-md-3">
                        <div class="section-heading">
                            <h4>lorem ipsum</h4>
                            <p>
                                Discover our latest publications, offering insights into key topics such as renewable energy, emission reduction strategies, and sustainable development.
                            </p>
                        </div>

                        <div class="row pt-20">
                            <div class="col-md-12">
                                <a href="" class="btn btn-success" style="width:100%;">Download JSON</a>
                            </div>

                        </div>
                    </div>
                    <div class="col-md-1"></div>
                    <div class="col-md-8">
                        <div id="container2" class="bg-gray" style="width: 100%; height: 600px;"></div>
                        <div id="fixed-tooltip"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="our-blog-section bg-gray">

            <div class="container">
                <div class="row">
                    <div class="col-md-3">
                        <div class="section-heading">
                            <h4>lorem ipsum</h4>
                            <p>
                                Discover our latest publications, offering insights into key topics such as renewable energy, emission reduction strategies, and sustainable development.
                            </p>
                        </div>

                        <div class="row pt-20">
                            <div class="col-md-6 mb-3">
                                <a href="" class="btn btn-success" style="width:100%;">JSON</a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="" class="btn btn-danger" style="width:100%;">CSV</a>
                            </div>
                            <div class="col-md-12 mb-3">
                                <select id="incident-filter" class="form-select btn outline-btn">
                                    <label for="incident-filter">Select Year:</label><br>
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1"></div>
                    <div class="col-md-8">
                        <div id="category-container" class="bg-gray" style="width: 100%; height: 600px;"></div>

                    </div>
                </div>
            </div>
        </section>
        <!--blog section end-->
        <section class="our-blog-section ptb-100 bg-main" style="background-color: #6665e5;">
            <div class="container ">
                <h2 class="text-white">Documents</h2>
             </div>
            <hr class="pb-100" style="border-top: 1px solid white;">
            <div class="container">
                <div class="row">
                    <div class="col-md-8">
                        <div class="section-heading mb-5">
                            <h2 class="text-white">Events</h2>
                            <p class="text-white">
                               Join our events to connect with experts and discuss decarbonization and sustainable development. Participate in workshops and seminars to inspire a greener future.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    {% for a in events %}
                    <div class="col-md-3">
                        <div class="single-blog-card">
                            <div class="post-meta my-2">
                                <ul class="list-inline meta-list">
                                    <li class="list-inline-item">{{ a.formatted_date }}</li>
                                    <li class="list-inline-item">|</li>
                                    <li class="list-inline-item">{{a.formatted_time}}</li>
                                </ul>
                            </div>
                            <h3 class="h5 card-title"><a href="{{ a.get_url }}">{{a.title}}</a></h3>
                            <small>Speakers :
                                {% for author in a.speakers %}
                                    {{ author.author.name }}{% if forloop.revcounter > 2 %}, {% elif forloop.revcounter == 2 %} and {% endif %} <!-- Adjust this field based on your Teams model -->
                                {% endfor %}
                            </small><br>

                            <a href="{{ a.get_url }}" class="detail-link">Read more <span class="ti-arrow-right"></span></a>
                        </div>
                    </div>
                    {% endfor %}

                </div>

            </div>
        </section>
        <!--blog section end-->
        <section class="ptb-100">
        <div class="container ">
                    <h2>About</h2>
                 </div>
                <hr class="pb-100" style="border-top: 1px solid black;">
        <div class="container">

                <div id="faq" class="ptb-100 ">
                    <div class="row">
                        <div class="col-md-9 col-lg-8">
                            <div class="section-heading mb-5">
                                <h2>Frequently Asked Questions</h2>
                                <p>Get quick answers to common questions about renewable energy, emission reduction, and sustainable development in our FAQ section. Find clear and concise explanations to help you understand key topics and initiatives.</p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 col-lg-12">
                            <div id="accordion-one" class="accordion accordion-faq">
                                {% for b in faq %}
                                <div class="card mb-0">
                                    <a class="card-header collapsed" data-toggle="collapse" href="#collapse{{b.id}}">
                                        <h6 class="mb-0 d-inline-block">{{b.title}}
                                        </h6>
                                    </a>
                                    <div id="collapse{{b.id}}" class="collapse" data-parent="#accordion-one">
                                        <div class="card-body">
                                            <p>{{b.keterangan}}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                            </div>
                        </div>
                    </div>
                </div>
        </div>

        </section>

    </div>
{% endblock %}

{% block css %}
<style>
    .hero-equal-height {
      position: relative;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .hero-content-wrap,
    .credit-footer {
      position: relative;
      z-index: 1;
    }

    .credit-footer a {
      color: white;
      text-decoration: underline;
    }

    .grayscale {
      filter: grayscale(100%);
    }

    .highcharts-figure,
    .highcharts-data-table table {
        min-width: 360px;
        max-width: 800px;
        margin: 1em auto;
    }

    .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
    }

    .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
    }

    .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
    }

    .highcharts-data-table td,
    .highcharts-data-table th,
    .highcharts-data-table caption {
        padding: 0.5em;
    }

    .highcharts-data-table thead tr,
    .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
    }

    .highcharts-data-table tr:hover {
        background: #f1f7ff;
    }

    #container2 {
            position: relative;
            width: 800px;
            height: 600px;
        }
        #fixed-tooltip {
            position: absolute;
            right: 10px;
            bottom: 60px;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 100;
            display: none;
        }

  </style>

{% endblock %}

{% block js %}
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/world.js"></script>
{% endblock %}

{% block js_chart %}
<script>
        $(document).ready(function() {
            let chartData;
            let chart;

            // Fetch data from the API
            $.getJSON('/api/incidents/monthly/', function(data) {
                chartData = data;

                // Populate year filter
                const yearFilter = $('#yearFilter');
                chartData.forEach(yearData => {
                    yearFilter.append($('<option>', {
                        value: yearData.year,
                        text: yearData.year
                    }));
                });

                // Initial chart render
                updateChart(chartData[0].year);

                // Event listener for year filter change
                yearFilter.on('change', function() {
                    updateChart($(this).val());
                });
            });

            function updateChart(selectedYear) {
                const yearData = chartData.find(data => data.year === selectedYear);

                const categories = [];
                const incidentsData = [];
                const deathsData = [];
                const injuriesData = [];
                const infraDamageData = [];
                const infraDestroyedData = [];
                const childTotalData = [];

                yearData.data.forEach(monthData => {
                    categories.push(monthData.month);
                    incidentsData.push(monthData.incidents);
                    deathsData.push(monthData.total_deaths);
                    injuriesData.push(monthData.total_injuries);
                    infraDamageData.push(monthData.infra_damage);
                    infraDestroyedData.push(monthData.infra_destroyed);
                    childTotalData.push(monthData.child_total);
                });

                // Create or update the chart
                if (chart) {
                    chart.update({
                        xAxis: {
                            categories: categories
                        },
                        series: [{
                            name: 'Incidents',
                            data: incidentsData
                        }, {
                            name: 'Total Deaths',
                            data: deathsData
                        }, {
                            name: 'Total Injuries',
                            data: injuriesData
                        }, {
                            name: 'Infrastructure Damage',
                            data: infraDamageData
                        }, {
                            name: 'Infrastructure Destroyed',
                            data: infraDestroyedData
                        }, {
                            name: 'Child Casualities',
                            data: childTotalData
                        }]
                    });
                } else {
                    chart = Highcharts.chart('container', {
                        chart: {
                            type: 'line'
                        },
                        title: {
                            text: 'Monthly Incident Statistics',
                            align: 'left'
                        },
                        subtitle: {
                            text: `Occurrence and Casualties in ${selectedYear}`,
                            align: 'left'
                        },
                        xAxis: {
                            categories: categories,
                            crosshair: true
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: 'Count'
                            }
                        },
                        legend: {
                            layout: 'horizontal',
                            align: 'center',
                            verticalAlign: 'bottom'
                        },
                        tooltip: {
                            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                                '<td style="padding:0"><b>{point.y}</b></td></tr>',
                            footerFormat: '</table>',
                            shared: true,
                            useHTML: true
                        },
                        plotOptions: {
                            line: {
                                dataLabels: {
                                    enabled: true
                                },
                                enableMouseTracking: true
                            }
                        },
                        series: [{
                            name: 'Incidents',
                            data: incidentsData
                        }, {
                            name: 'Total Deaths',
                            data: deathsData
                        }, {
                            name: 'Total Injuries',
                            data: injuriesData
                        }, {
                            name: 'Infrastructure Damage',
                            data: infraDamageData
                        }, {
                            name: 'Infrastructure Destroyed',
                            data: infraDestroyedData
                        }, {
                            name: 'Child Casualities',
                            data: childTotalData
                        }]
                    });
                }
            }
        });
    </script>

<script>
(async () => {
    const [geoJsonData, apiData] = await Promise.all([
        fetch('http://localhost:8000/static/indo.json').then(response => response.json()),
        fetch('http://localhost:8000/api/incident-counts/').then(response => response.json())
    ]);

    geoJsonData.features.forEach(feature => {
        feature.properties.prov_id = feature.properties.prov_id.padStart(2, '0');
    });

    const incidentData = apiData.map(item => ({
        'prov_id': item.province_area_code.toString().padStart(2, '0'),
        'incident_count': item.incident_count,
        'population': item.population,
        'incident_ratio': item.incident_ratio,
        'name': item.province_name
    }));

    const ratioValues = incidentData.map(item => item.incident_ratio).filter(Boolean);
    const minRatio = Math.min(...ratioValues);
    const maxRatio = Math.max(...ratioValues);

    Highcharts.mapChart('container2', {
        chart: {
            map: geoJsonData
        },
        title: {
            text: 'Indonesia Incident Ratio Map',
            align: 'left'
        },
        subtitle: {
            text: 'Incidents per 10,000 population',
            align: 'left'
        },
        mapNavigation: {
            enabled: true,
            buttonOptions: {
                verticalAlign: 'bottom'
            }
        },
        colorAxis: {
            min: 0,
            max: 0.02000,
            minColor: '#FFFFFF',
            maxColor: '#003399',
            stops: [
                [0, '#FFFFFF'],
                [0.2, '#E6F0FF'],
                [0.4, '#B3D1FF'],
                [0.6, '#80B3FF'],
                [0.8, '#4D94FF'],
                [1, '#003399']
            ],
            labels: {
                format: '{value:.5f}'
            }
        },
        legend: {
            title: {
                text: 'Incidents per 10,000 population'
            }
        },
        tooltip: {
            formatter: function () {
                const point = incidentData.find(item => item.prov_id === this.point.properties.prov_id);
                if (point) {
                    return `<b>${point.name}</b><br>` +
                           `Incidents: ${Highcharts.numberFormat(point.incident_count, 0)}<br>` +
                           `Population: ${point.population ? Highcharts.numberFormat(point.population, 0) : 'N/A'}<br>` +
                           `Ratio: ${point.incident_ratio ? Highcharts.numberFormat(point.incident_ratio, 5) : 'N/A'} per 10,000`;
                }
                return 'No data available';
            }
        },
        series: [{
            data: incidentData,
            joinBy: ['prov_id', 'prov_id'],
            name: 'Incident Ratio',
            states: {
                hover: {
                    color: '#FFA726'
                }
            },
            dataLabels: {
                enabled: false
            }
        }]
    });
})();
</script>

<script>
$(document).ready(function() {
    let chartData;
    let categoryChart;

    // Fetch data from the API
    $.getJSON('/api/incidents-by-category/', function(data) {
        chartData = data;

        // Populate year filter
        const incidentFilter = $('#incident-filter');
        chartData.forEach(yearData => {
            incidentFilter.append($('<option>', {
                value: yearData.year,
                text: yearData.year
            }));
        });

        // Initial chart render with the first year
        if (chartData.length > 0) {
            updateCategoryChart(chartData[0].year);
        }

        // Event listener for year filter change
        incidentFilter.on('change', function() {
            updateCategoryChart($(this).val());
        });
    });

    function updateCategoryChart(selectedYear) {
        if (!selectedYear) return; // Don't update if no year is selected

        const yearData = chartData.find(data => data.year === selectedYear);
        if (!yearData) return; // Don't update if year data is not found

        const categories = [];
        const seriesData = {};

        yearData.data.forEach(monthData => {
            categories.push(monthData.month);
            Object.keys(monthData).forEach(key => {
                if (key !== 'month' && key !== 'incidents') {
                    if (!seriesData[key]) {
                        seriesData[key] = [];
                    }
                    seriesData[key].push(monthData[key]);
                }
            });
        });

        const series = Object.keys(seriesData).map(key => ({
            name: key,
            data: seriesData[key]
        }));

        // Create or update the chart
        if (categoryChart) {
            categoryChart.update({
                xAxis: {
                    categories: categories
                },
                series: series,
                subtitle: {
                    text: `Incident Types in ${selectedYear}`
                }
            });
        } else {
            categoryChart = Highcharts.chart('category-container', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: 'Monthly Incident Categories',
                    align: 'left'
                },
                subtitle: {
                    text: `Incident Types in ${selectedYear}`,
                    align: 'left'
                },
                xAxis: {
                    categories: categories,
                    crosshair: true
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Number of Incidents'
                    }
                },
                legend: {
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom'
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y}</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        pointPadding: 0.2,
                        borderWidth: 0
                    }
                },
                series: series
            });
        }
    }
});
</script>
{% endblock %}